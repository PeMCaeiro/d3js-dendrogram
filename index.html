<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dendogram with Timeline</title>

    <style>
        .node circle {
            /*fill: steelblue;
            stroke: grey;
            stroke-width: 3px;*/
        }

        .node text {
            font: 9px sans-serif;
        }

        /* link is for the lines */

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
            z-index: -1;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: slategray;
            shape-rendering: crispEdges;
        }

        .x.axis line,
        .x.axis path {
            fill: none;
            stroke: #000;
        }

        .legend {
            font-family: Arial, sans-serif;
            font-size: 10px;
        }

        .legend rect {
            stroke-width: 1px;
        }

        .level-0 {
            opacity: 0;
        }

        .link.level-1 {
            /*opacity: 0;*/
        }

        .node.level-1 {
            /*opacity: 0;*/
        }

        .node.level-1 .ntext {
            /*opacity: 0;*/
        }
    </style>
</head>

<body>
    <!--/div-->
    <!--button id='saveButton'>Export my D3 visualization to PNG</button-->
    <!-- load the d3.js library -->
    <script src="http://d3js.org/d3.v7.min.js"></script>
    <script
        src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script
        src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>

    <script>
        var treeData =
        {
            'name': 'Root', 'year': 1915, 'depth': 0, 'family': 'Root Family', 'children': [
                {
                    'name': 'Pharma', 'family': 'Pharma', 'year': 1928, 'depth': 1, 'children': [
                        { 'name': 'Penicilin', 'family': 'Pharma', 'year': 1928, 'depth': 2, },
                        { 'name': 'Streptomycin', 'family': 'Pharma', 'year': 1945, 'depth': 2, },
                        { 'name': 'Oral Contraceptive Pill', 'family': 'Pharma', 'year': 1949, 'depth': 2, },
                        { 'name': 'Polio Vaccine', 'family': 'Pharma', 'year': 1953, 'depth': 2, },
                        { 'name': 'First Antiviral Approved (Idoxuridine)', 'family': 'Pharma', 'year': 1963, 'depth': 2, },
                        { 'name': 'Hepatitis B Vaccine', 'family': 'Pharma', 'year': 1980, 'depth': 2, },
                        { 'name': 'First Recombinant DNA Vaccine', 'family': 'Pharma', 'year': 1980, 'depth': 2, },
                        { 'name': 'First Protease Inhibitor for HIV/AIDS Approved by FDA', 'family': 'Pharma', 'year': 1995, 'depth': 2, },
                        { 'name': 'Introduction of Highly Active Antiretroviral Therapy (HAART) for HIV/AIDS', 'family': 'Pharma', 'year': 1996, 'depth': 2, },
                        { 'name': 'Viagra (sildenafil) approved for the treatment of erectile dysfunction', 'family': 'Pharma', 'year': 1998, 'depth': 2, },
                        { 'name': 'Introduction of Human Papillomavirus (HPV) Vaccine', 'family': 'Pharma', 'year': 2003, 'depth': 2, },
                        { 'name': 'Approval of the first Targeted Cancer Therapy (Gleevec)', 'family': 'Pharma', 'year': 2005, 'depth': 2, },
                        { 'name': 'Approval of the First Direct Oral Anticoagulant (DOAC)', 'family': 'Pharma', 'year': 2012, 'depth': 2, },
                        { 'name': 'CRISPR-Cas9: gene-editing tool that allows precise modification of DNA sequences', 'family': 'Pharma', 'year': 2012, 'depth': 2, },
                        { 'name': 'Development of Pembrolizumab (Keytruda) as an Immune Checkpoint Inhibitor for Cancer', 'family': 'Pharma', 'year': 2014, 'depth': 2, },
                        { 'name': 'Approval of the first immunotherapy drug for cancer treatment', 'family': 'Pharma', 'year': 2015, 'depth': 2, },
                        { 'name': 'Introduction of the first FDA-approved Artificial Pancreas for Diabetes', 'family': 'Pharma', 'year': 2015, 'depth': 2, },
                        { 'name': 'Introduction of CAR-T Cell Therapy for Cancer', 'family': 'Pharma', 'year': 2017, 'depth': 2, },
                        { 'name': 'Gene Therapy for Genetic Disorders', 'family': 'Pharma', 'year': 2019, 'depth': 2, },
                        { 'name': 'Development of mRNA Vaccines (e.g., Pfizer-BioNTech COVID-19 vaccine)', 'family': 'Pharma', 'year': 2019, 'depth': 2, },
                        { 'name': 'Rapid development and distribution of COVID-19 vaccines', 'family': 'Pharma', 'year': 2020, 'depth': 2, },
                        { 'name': 'FDA approval of the first gene therapy for an inherited retinal disease', 'family': 'Pharma', 'year': 2021, 'depth': 2, },
                    ]
                },
                {
                    'name': 'MD', 'family': 'MD', 'year': 2010, 'depth': 1, 'children': [
                        { 'name': '3D Printing in Medicine: Advancements enabled the creation of patient-specific medical implants', 'family': 'MD', 'year': 2010, 'depth': 2, },
                        { 'name': 'Approval of the First Artificial Retina', 'family': 'MD', 'year': 2012, 'depth': 2, },
                        { 'name': 'Personalized Medicine based on Gut Microbiome Analysis', 'family': 'MD', 'year': 2023, 'depth': 2, },
                    ]
                },
                {
                    'name': 'Active MD', 'family': 'Active MD', 'year': 2012, 'depth': 1, 'children': [
                        { 'name': 'Approval of the first fully implantable artificial heart', 'family': 'Active MD', 'year': 2012, 'depth': 2, },
                        { 'name': 'First successful implantation of a bionic eye', 'family': 'Active MD', 'year': 2013, 'depth': 2, },
                        { 'name': 'Development of the first commercial exoskeleton for paraplegics', 'family': 'Active MD', 'year': 2016, 'depth': 2, },
                        { 'name': 'Brain-Computer Interfaces (BCIs) for Paralysis Patients', 'family': 'Active MD', 'year': 2022, 'depth': 2, },
                        { 'name': 'AI in Healthcare: medical image analysis, diagnosis and drug discovery', 'family': 'Active MD', 'year': 2023, 'depth': 2, },
                    ]
                },
                {
                    'name': 'IT', 'family': 'IT', 'year': 1990, 'depth': 1, 'children': [
                        { 'name': 'Human Genome Project Launched', 'family': 'IT', 'year': 1990, 'depth': 2, },
                        { 'name': 'Deep Blue (Computer Chess Champion)', 'family': 'IT', 'year': 1995, 'depth': 2, },
                        { 'name': 'Telemedicine', 'family': 'IT', 'year': 1996, 'depth': 2, },
                        { 'name': 'Introduction of electronic health records (EHRs)', 'family': 'IT', 'year': 2003, 'depth': 2, },
                        { 'name': 'YouTube (Health Education Videos)', 'family': 'IT', 'year': 2005, 'depth': 2, },
                        { 'name': 'Introduction of the Apple iPhone, leading to the rise of mobile health applications', 'family': 'IT', 'year': 2007, 'depth': 2, },
                        { 'name': 'Launch of the first smartphone application for remote health monitoring', 'family': 'IT', 'year': 2008, 'depth': 2, },
                        { 'name': 'Google Glass (Augmented Reality in Surgery)', 'family': 'IT', 'year': 2013, 'depth': 2, },
                        { 'name': 'Launch of Fitbit, popularizing wearable fitness trackers', 'family': 'IT', 'year': 2013, 'depth': 2, },
                        { 'name': 'Launch of Apple\'s HealthKit', 'family': 'IT', 'year': 2013, 'depth': 2, },
                        { 'name': 'Launch of the Apple Watch with Health Monitoring Features', 'family': 'IT', 'year': 2015, 'depth': 2, },
                        { 'name': 'Development of the first commercial Virtual Reality (VR) Surgical Simulator', 'family': 'IT', 'year': 2016, 'depth': 2, },
                        { 'name': 'Blockchain Technology in Healthcare', 'family': 'IT', 'year': 2017, 'depth': 2, },
                        { 'name': 'Advancements in Artificial Intelligence (AI) for Medical Diagnosis', 'family': 'IT', 'year': 2022, 'depth': 2, },
                        { 'name': 'Advancements in AI-driven diagnostics and precision medicine', 'family': 'IT', 'year': 2023, 'depth': 2, },
                    ]
                },
                {
                    'name': 'Methods', 'family': 'Methods', 'year': 2014, 'depth': 1, 'children': [
                        { 'name': 'Precision Medicine and Genomics', 'family': 'Methods', 'year': 2014, 'depth': 2, },
                        { 'name': 'Robotic-Assisted Surgery', 'family': 'Methods', 'year': 2018, 'depth': 2, },
                        { 'name': 'Tailored treatment plans based on an individual\'s genetic makeup and environment', 'family': 'Methods', 'year': 2023, 'depth': 2, },
                    ]
                },
                /*{
                    'name': 'Management', 'family': 'Management', 'year': 2010, 'depth': 1, 'children': [
                        { 'name': 'N/A', 'family': 'Management', 'year': 2010, 'depth': 2, },
                    ]
                },*/
                {
                    'name': 'Basic R&D', 'family': 'Basic R&D', 'year': 1953, 'depth': 1, 'children': [
                        { 'name': 'Determination of DNA Structure by James Watson and Francis Crick', 'family': 'Basic R&D', 'year': 1953, 'depth': 2, },
                        { 'name': 'Identification of the Human Immunodeficiency Virus (HIV) by Luc Montagnier and Robert Gallo', 'family': 'Basic R&D', 'year': 1981, 'depth': 2, },
                        { 'name': 'Identification of HIV as the Cause of AIDS', 'family': 'Basic R&D', 'year': 1983, 'depth': 2, },
                        { 'name': 'Development of the World Wide Web ', 'family': 'Basic R&D', 'year': 1990, 'depth': 2, },
                        { 'name': 'Cloning of Dolly the sheep, the first mammal cloned from an adult cell', 'family': 'Basic R&D', 'year': 1996, 'depth': 2, },
                        { 'name': 'Human Genome Project: sequencing the entire human genome was completed', 'family': 'Basic R&D', 'year': 2003, 'depth': 2, },
                        { 'name': 'Discovery of Induced Pluripotent Stem Cells (iPSCs)', 'family': 'Basic R&D', 'year': 2006, 'depth': 2, },
                        { 'name': 'Development of Induced Pluripotent Stem Cells (iPSCs) by Shinya Yamanaka', 'family': 'Basic R&D', 'year': 2008, 'depth': 2, },
                        { 'name': 'CRISPR-Cas9 - Gene editing technology discovered', 'family': 'Basic R&D', 'year': 2008, 'depth': 2, },
                        { 'name': 'Immunotherapy Breakthroughs', 'family': 'Basic R&D', 'year': 2015, 'depth': 2, },
                    ]
                },
            ]
        };

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10); // Color scale for families


        var margin = { top: 20, right: 90, bottom: 30, left: 90 },
            width = 2000 - margin.left - margin.right,
            height = 1600 - margin.top - margin.bottom;

        var treemap = d3.tree()
            .size([height, width]);

        var nodes = d3.hierarchy(treeData, function (d) {
            return d.children;
        });

        nodes = treemap(nodes);

        var svg = d3.select('body').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom),
            g = svg.append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');


        var formatNumber = d3.format('');
        var x = d3.scaleLinear()
            .domain([1915, 2025])
            //original rang is 0,widtd
            .range([50, width - margin.left - margin.right - 85]);
        var xAxis = d3.axisBottom(x)
            .ticks(30)
            .tickFormat(formatNumber);
        g.append('g')
            .attr('transform', 'translate(0,' + height + ')')
            .style("font-size", "14px")
            .attr('class', 'axis')
            .call(customXAxis);
        function customXAxis(g) {
            g.call(xAxis);
            //g.select('.domain').remove(); //removes line in axis
        };

        //---------------------CHANGE X AXIS TICKS---------------------------

        //d3.selectAll(".tick").filter(function (d) { return d === 0;  }).remove();
        d3.select(".tick").remove();
        d3.select(".tick").remove();


        var link = g.selectAll('.link')
            .data(nodes.descendants().slice(1))
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr("class", function (d) {
                return 'link level-' + d.data.depth
            })
            .attr('d', function (d) {
                return 'M' + x(d.data.year) + ',' + d.x
                    + 'C' + (x(d.data.year) + x(d.parent.data.year)) / 2 + ',' + d.x
                    + ' ' + (x(d.data.year) + x(d.parent.data.year)) / 2 + ',' + d.parent.x
                    + ' ' + x(d.parent.data.year) + ',' + d.parent.x;
            });

        var node = g.selectAll('.node')
            .data(nodes.descendants())
            .enter()
            /*
            .filter(d => d.data.name !== "Root" && d.data.name !== "Pharma" && d.data.name !== "MD"
                && d.data.name !== "Active MD" && d.data.name !== "IT" && d.data.name !== "Methods" && d.data.name !== "Management"
                && d.data.name !== "Basic R&D") // Exclude the root & class nodes
            */
            .append('g')
            .attr('class', function (d) {
                return 'node' +
                    (d.children ? ' node--internal' : ' node--leaf');
            })
            .attr("class", function (d) {
                return 'node level-' + d.depth; // add the node depth
            })
            .attr('transform', function (d) {
                return 'translate(' + x(d.data.year) + ',' + d.x + ')';
            });

        node.append('circle')
            .attr('r', 7.5)
            .style("fill", d => colorScale(d.data.family)); // Color nodes based on family property

        node.append('text')
            .attr("class", "ntext")
            .attr('dy', '.35em')
            .attr('x', function (d) { return d.children ? -13 : 13; })
            .style('text-anchor', function (d) {
                return d.children ? 'end' : 'start';
            })
            //.text(function (d) { return + (d.data.year) + " - " + d.data.name; });
            .text(function (d) { return isNodeNameLevel1(d) ? d.data.name : d.data.year + " - " + d.data.name; });


        // Create a legend for node families
        const legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", `translate(1200, ${0 + 50})`);

        const excludedFamily = "Root Family"; // Specify the family to be excluded
        const families = [...new Set(nodes.descendants().map((d) => d.data.family))];
        families.forEach((family, i) => {
            // Exclude the specified family from the legend
            if (family !== excludedFamily) {
                const legendItem = legend.append("g")
                    .attr("transform", `translate(${i * 90}, 0)`);

                legendItem.append("rect")
                    .attr("width", 12)
                    .attr("height", 12)
                    .attr("fill", colorScale(family));

                legendItem.append("text")
                    .attr("x", 16)
                    .attr("y", 9)
                    .attr("dy", ".35em")
                    .text(family);
            }
        });

        // Set-up the export button
        d3.select('#saveButton').on('click', function () {
            var svgString = getSVGString(d3.select('svg').node());
            svgString2Image(svgString, 2 * width, 2 * height, 'png', save); // passes Blob and filesize String to the callback

            function save(dataBlob, filesize) {
                saveAs(dataBlob, 'D3 viz exported to PNG.png'); // FileSaver.js function
            }
        });

        // Below are the functions that handle actual exporting:
        // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
        function getSVGString(svgNode) {
            svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
            var cssStyleText = getCSSStyles(svgNode);
            appendCSS(cssStyleText, svgNode);

            var serializer = new XMLSerializer();
            var svgString = serializer.serializeToString(svgNode);
            svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
            svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

            return svgString;

            function getCSSStyles(parentElement) {
                var nodesToCheck = [parentElement], i;

                // Add all the different nodes to check
                var childNodes = parentElement.getElementsByTagName("*");
                for (i = 0; i < childNodes.length; i++) {
                    nodesToCheck.push(childNodes[i]);
                }

                // Extract CSS Rules
                var extractedCSSRules = [];
                for (i = 0; i < document.styleSheets.length; i++) {
                    var s = document.styleSheets[i];

                    try {
                        if (!s.cssRules) continue;
                    } catch (e) {
                        if (e.name !== 'SecurityError') throw e; // for Firefox
                        continue;
                    }

                    var cssRules = s.cssRules;
                    var ruleMatches;
                    for (var r = 0; r < cssRules.length; r++) {
                        ruleMatches = nodesToCheck.reduce(function (a, b) {
                            return a || b.matches(cssRules[r].selectorText);
                        }, false);
                        if (ruleMatches)
                            extractedCSSRules.push(cssRules[r].cssText);
                    }
                }
                return extractedCSSRules.join(' ');
            }
            function appendCSS(cssText, element) {
                var styleElement = document.createElement("style");
                styleElement.setAttribute("type", "text/css");
                styleElement.innerHTML = cssText;
                var refNode = element.hasChildNodes() ? element.children[0] : null;
                element.insertBefore(styleElement, refNode);
            }
        }


        function svgString2Image(svgString, width, height, format, callback) {
            var format = format ? format : 'png';

            var imgsrc = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString))); // Convert SVG string to data URL

            var canvas = document.createElement("canvas");
            var context = canvas.getContext("2d");

            canvas.width = width;
            canvas.height = height;

            var image = new Image();
            image.onload = function () {
                context.clearRect(0, 0, width, height);
                context.drawImage(image, 0, 0, width, height);

                canvas.toBlob(function (blob) {
                    var filesize = Math.round(blob.length / 1024) + ' KB';
                    if (callback) callback(blob, filesize);
                });


            };

            image.src = imgsrc;
        }

        function hasClass(element, className) {
            return (' ' + element.className + ' ').indexOf(' ' + className + ' ') > -1;
        }

        function isNodeNameLevel1(d) {
            if (d.data.name == "Pharma" || d.data.name == "MD"
                || d.data.name == "Active MD" || d.data.name == "IT" || d.data.name == "Methods" || d.data.name == "Management"
                || d.data.name == "Basic R&D"){
                    return true; // Check  the root & class nodes
                }else{
                    return false;
                } 
        }

    </script>
</body>

</html>.
